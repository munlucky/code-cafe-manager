{"type":"entity","name":"codecafe::Boundary::AlwaysDo","entityType":"boundary","observations":["커밋 전 pnpm typecheck 실행","패키지 변경 시 해당 CLAUDE.md Flow 유지 확인","Export 변경 시 상위 패키지 영향 확인","IPC 핸들러에서 사용자 입력 경로는 validatePath로 검증 필수","프로덕션 코드에서 console.log는 조건부 로깅 적용 (devLog 패턴)"]}
{"type":"entity","name":"codecafe::Boundary::AskFirst","entityType":"boundary","observations":["새 의존성 추가","IPC 채널 추가/변경","Provider 인터페이스 변경"]}
{"type":"entity","name":"codecafe::Boundary::NeverDo","entityType":"boundary","observations":[".env 파일 커밋","기존 테스트 삭제","shell injection 가능한 exec 사용 (execFile 사용 필수)","innerHTML 직접 사용 금지 - DOM API (createElement, textContent) 사용","dangerouslySetInnerHTML에 escapeHtml 없이 데이터 전달 금지"]}
{"type":"entity","name":"codecafe::Documentation::ModuleSpecs","entityType":"documentation","observations":["docs/module-specs/README.md: Package Dependency Graph, Layer Architecture","packages/*/CLAUDE.md: 패키지별 Flow, File Map, API, Review Checklist",".claude/PROJECT.md: 전체 프로젝트 개요 및 아키텍처"]}
{"type":"entity","name":"codecafe::Architecture::Layers","entityType":"architecture","observations":["UI Layer: cli, desktop","Application Layer: orchestrator (facades, session, terminal, barista, engine, provider, workflow, role, storage)","Domain Layer: core (types, schema, errors, utils), schema","Infrastructure Layer: providers (common, claude-code, codex), git-worktree"]}
{"type":"entity","name":"codecafe::Convention::SecurityPatterns","entityType":"convention","observations":["exec 대신 execFile 사용 - 명령어 인젝션 방지","ALLOWED_COMMANDS 화이트리스트로 실행 가능한 명령어 제한","validatePath 함수로 경로 traversal 공격 방지","escapeHtml -> convertAnsiToHtml 순서로 XSS 방지","pnpm.overrides로 취약한 간접 의존성 버전 강제"]}
{"type":"entity","name":"@codecafe/orchestrator::Boundary::AlwaysDo","entityType":"boundary","observations":["커밋 전 pnpm run typecheck 실행","커밋 전 pnpm test 실행 (56 passed 확인)","Strategy 패턴 도입 시 interface 먼저 정의","상태 전이 규칙은 한 곳에 집중 (SessionStateMachine)"]}
{"type":"entity","name":"@codecafe/orchestrator::Boundary::AskFirst","entityType":"boundary","observations":["SESSION_TRANSITIONS 변경 시 팀 리뷰 필요","failed 상태에서 cancelled 전이 허용 시 보안 검토 필요"]}
{"type":"entity","name":"@codecafe/orchestrator::Boundary::NeverDo","entityType":"boundary","observations":["상태 전이 검증 없이 상태 직접 변경 금지","분산된 MAX_RETRIES 상수 사용 금지 (RetryPolicyManager 사용)","require() 사용 금지 (ES Module import 사용)"]}
{"type":"entity","name":"@codecafe/orchestrator::Component::SessionStateMachine","entityType":"component","observations":["state-machine/session-state-machine.ts에 위치","SessionLifecycle에서 리네임됨 (2026-02-03)","InvalidStateTransitionError로 유효하지 않은 전이 방지","failed→cancelled 전이 불허 (사용자 요청)","편의 메서드 제공: start(), complete(), fail(), cancel(), resume(), enterFollowup()","하위 호환성 유지: getStatus(), setStatus() 별칭"]}
{"type":"entity","name":"@codecafe/orchestrator::Component::StageEvaluatorChain","entityType":"component","observations":["orchestration/strategies/stage-evaluator-chain.ts에 위치","Strategy 패턴으로 Stage 평가 로직 분리 (2026-02-03)","AnalyzeStageEvaluator: analyze/plan 스테이지 전용 (질문 무시)","DefaultStageEvaluator: 일반적인 Stage 평가","stage-orchestrator.ts의 evaluateWithAI() 135줄 분리"]}
{"type":"entity","name":"@codecafe/orchestrator::Component::RetryPolicyManager","entityType":"component","observations":["retry/retry-policy-manager.ts에 위치","중앙화된 재시도 카운터 관리 (2026-02-03)","ExponentialBackoffPolicy, FixedDelayPolicy, NoRetryPolicy 지원","분산된 MAX_RETRIES 상수 대체"]}
{"type":"entity","name":"@codecafe/orchestrator::Component::RetryStrategyFactory","entityType":"component","observations":["retry/retry-strategy.ts에 위치","RetryFromStageStrategy: 특정 stage부터 재시도","RetryFromBeginningStrategy: 처음부터 재시도","OrderSession의 retryFromStage(), retryFromBeginning() 로직 분리"]}
{"type":"entity","name":"@codecafe/orchestrator::Component::WorkflowLoader","entityType":"component","observations":["barista/services/workflow-loader.ts에 위치","barista-engine-v2.ts에서 80줄 추출 (2026-02-03)","YAML 파싱, 스킬 로딩, WorkflowConfig 빌드 분리","LRU cache for skills"]}
{"type":"entity","name":"@codecafe/orchestrator::Component::ParallelStageProcessor","entityType":"component","observations":["session/execution/parallel-stage-processor.ts에 위치","stage-coordinator.ts에서 135줄 추출 (2026-02-03)","processParallelResults() 복잡한 로직 분리","ParallelResultHandler로 결정 로직 분리"]}
{"type":"entity","name":"@codecafe/orchestrator::Convention::StateTransitions","entityType":"convention","observations":["상태 전이는 SessionStateMachine.state-machine/session-state.ts의 SESSION_TRANSITIONS에 정의","전이 검증은 canTransition() 함수 사용","유효하지 않은 전이는 InvalidStateTransitionError throw"]}
{"type":"entity","name":"@codecafe/orchestrator::Convention::StrategyPattern","entityType":"convention","observations":["Strategy 패턴 사용 시 interface 먼저 정의 (stage-evaluator.ts)","구현체는 별도 파일 (analyze-stage-evaluator.ts, default-stage-evaluator.ts)","체인 패턴으로 다중 evaluator 조합 (stage-evaluator-chain.ts)","ES Module import 사용 (require 금지)"]}
{"type":"entity","name":"@codecafe/orchestrator::Convention::FileStructure","entityType":"convention","observations":["internal modules: session/lifecycle/, session/execution/, session/resources/, session/events/","각 모듈은 index.ts로 export","Strategy 패턴은 strategies/ 하위 디렉토리"]}
{"type":"entity","name":"@codecafe/orchestrator::Architecture::Week3Refactoring","entityType":"architecture","observations":["2026-02-03 Week 3 완료: State Management 리팩토링","SessionLifecycle → SessionStateMachine 리네임","StageEvaluator Strategy 패턴 도입 (135줄 분리)","RetryStrategy 패턴 도입 (재시도 로직 분리)","failed→cancelled 전이 불허 (사용자 요청)","테스트 56 passed, 타입 체크 통과","코드 리뷰 APPROVE"]}
{"type":"entity","name":"codecafe::Component::ResourceLifecycleIntegrationTest","entityType":"component","observations":["위치: packages/orchestrator/src/__tests__/resource-lifecycle.integration.test.ts","목적: Week 4 리팩토링 - 리소스 라이프사이클 통합 테스트","테스트 수: 20개","시나리오: Basic Disposal (T1-T4), Memory Leak Prevention (T5-T8), Crash Recovery (T9-T12), Concurrency (T13-T16), Edge Cases (T17-T20)","생성일: 2026-02-03","검증: 76/76 테스트 통과 (100%)"]}
{"type":"entity","name":"codecafe::Project::OrchestratorWeek4Refactor","entityType":"milestone","observations":["완료일: 2026-02-03","상태: 완료 (Week 1-4 ALL COMPLETED)","추가 파일: resource-lifecycle.integration.test.ts (20개 테스트)","검증: 76/76 테스트 통과","결정: 옵션 A 선택 - 기존 dispose() 패턴 검증","총 소요 시간: ~2.5시간 (예상 8-12시간)","전체 생성 파일: 22개 (Week 1: 8, Week 2: 4, Week 3: 9, Week 4: 1)"]}
{"type":"entity","name":"codecafe::Convention::IntegrationTestPattern","entityType":"convention","observations":["위치: packages/orchestrator/src/__tests__/","패턴: 시나리오 기반 통합 테스트 (describe-it pattern)","테스트 ID: T{N} 형식 (추적용)","Mocking: MockProviderAdapter 사용","검증: vitest + chai","파일 명명: {feature}.integration.test.ts"]}
{"type":"entity","name":"[codecafe]::Boundary::AlwaysDo","entityType":"boundary","observations":["커밋 전 pnpm build 실행하여 빌드 검증","Provider 변경 시 BaseProvider 추상 클래스 활용","CLI 설정은 config.ts의 CONFIG 객체 사용","타입 캐스팅(as) 대신 타입 가드 함수 사용"]}
{"type":"entity","name":"[codecafe]::Boundary::AskFirst","entityType":"boundary","observations":["새 Provider 추가 시 BaseProvider 상속 구조 검토","packages/core 타입 변경 시 영향 범위 확인","CLI 옵션 변경 시 호환성 검토"]}
{"type":"entity","name":"[codecafe]::Boundary::NeverDo","entityType":"boundary","observations":["Provider에 중복 로직 직접 구현 금지 (BaseProvider 사용)","CLI 명령어에 설정 헬퍼 직접 정의 금지 (config.ts 사용)","unsafe type cast (as) 남용 금지"]}
{"type":"entity","name":"[codecafe]::Convention::ProviderPattern","entityType":"convention","observations":["모든 Provider는 BaseProvider 추상 클래스 상속","Provider별 고유 로직만 구현: getCommandName(), buildInteractiveCommand(), buildHeadlessArgs(), getAuthHint()","공통 로직(run, write, stop, executeWithSchema)은 BaseProvider에서 처리","validateEnv()는 static 메서드로 BaseProvider.validateEnvForCommand() 호출"]}
{"type":"entity","name":"[codecafe]::Convention::CLIConfig","entityType":"convention","observations":["모든 CLI 설정은 cli/src/config.ts의 CONFIG 객체에서 관리","CONFIG.dir, CONFIG.dataDir, CONFIG.logsDir, CONFIG.defaultProvider 사용","ensureConfigDir(), ensureAllDirs() 함수로 디렉토리 초기화","에러 처리는 utils/error-handler.ts의 handleError() 사용"]}
{"type":"entity","name":"[codecafe]::Convention::TypeGuards","entityType":"convention","observations":["Partial<T>를 T로 변환 시 타입 가드 함수 사용","타입 가드 함수명: isValid{TypeName} 패턴 (예: isValidWorktreeInfo)","타입 가드는 해당 타입 파일(types.ts)에 함께 정의"]}
{"type":"entity","name":"[codecafe]::Component::BaseProvider","entityType":"component","observations":["위치: packages/providers/common/src/base-provider.ts","역할: Provider 공통 로직 추상 클래스 (331줄)","제공 기능: run(), write(), stop(), isActive(), executeWithSchema(), validateEnvForCommand()","추상 메서드: getCommandName(), buildInteractiveCommand(), buildHeadlessArgs(), getAuthHint()","타임아웃 정리 로직 포함 (clearTimeout)"]}
{"type":"entity","name":"[codecafe]::Component::Platform","entityType":"component","observations":["위치: packages/providers/common/src/utils/platform.ts","역할: 플랫폼 감지 유틸리티","제공: isWindows(), isMac(), isLinux(), getShell(), getLineEnding(), getCommandCheck(), getExecutableExtension()"]}
{"type":"entity","name":"[codecafe]::Component::CLIConfig","entityType":"component","observations":["위치: packages/cli/src/config.ts","역할: CLI 설정 중앙 관리","CONFIG 객체: dir, dataDir, logsDir, defaultProvider, orchDir","함수: ensureConfigDir(), ensureAllDirs()"]}
{"type":"relation","from":"codecafe::Architecture::Layers","to":"codecafe::Documentation::ModuleSpecs","relationType":"documented_in"}
{"type":"relation","from":"codecafe::Boundary::AlwaysDo","to":"codecafe::Documentation::ModuleSpecs","relationType":"enforces"}
{"type":"relation","from":"codecafe::Component::ResourceLifecycleIntegrationTest","to":"codecafe::Project::OrchestratorWeek4Refactor","relationType":"part_of"}
{"type":"relation","from":"codecafe::Component::ResourceLifecycleIntegrationTest","to":"codecafe::Convention::IntegrationTestPattern","relationType":"follows"}
{"type":"relation","from":"[codecafe]::Component::BaseProvider","to":"[codecafe]::Component::Platform","relationType":"uses"}
{"type":"relation","from":"[codecafe]::Convention::ProviderPattern","to":"[codecafe]::Component::BaseProvider","relationType":"describes"}