# 2026-02-03 Orchestrator 패키지 리팩토링 세션

## Session metadata
- Start time: 10:00
- End time: (in progress)
- Main work: @codecafe/orchestrator 패키지 리팩토링 (Week 1-4 계획)
- Branch: main
- Owner: dev
- Plan document: `docs/architecture/refactoring-plans/package-orchestrator.md`

## Timeline

### [10:00] Work started
- User request: "docs/architecture/refactoring-plans/package-orchestrator.md 리팩토링 작업 진행해줘"
- Moonshot Orchestrator 실행
- Task type: refactor
- Complexity: complex (20-25h estimated)
- Phase: implementation

### [10:02] PM Analysis - Task Classification
- Skill: `/moonshot-classify-task`
- Result: taskType=refactor, confidence=high
- Keywords: refactor, split-functions, reduce-nesting, state-machine, retry-policy, type-safety

### [10:03] PM Analysis - Complexity Evaluation
- Skill: `/moonshot-evaluate-complexity`
- Result: complexity=complex
- Estimates: 10 files, 600 lines, 8h
- Target files: 5개 (2,824 LOC total)

### [10:04] PM Analysis - Uncertainty Detection
- Skill: `/moonshot-detect-uncertainty`
- Missing info detected:
  1. Test strategy (17/56 tests failing)
  2. API compatibility strategy

### [10:05] User clarification received
- Test strategy: "실패 테스트 먼저 수정"
- API compatibility: "API 스펙 유지하면 됨" (내부만 리팩토링)

### [10:06] PM Analysis - Sequence Decision
- Skill: `/moonshot-decide-sequence`
- Phase: implementation (with test-fix-first constraint)
- Chain: test-fixer → pre-flight-check → implementation-runner → ...

### [10:10] Task #1: 실패 테스트 수정 (17개)
- **Status**: in_progress
- Root cause analysis:
  - `barista-engine-v2.test.ts`: MockSession이 EventEmitter가 아님 → 이벤트 전파 실패
  - `terminal-pool.test.ts`: `acquireLease(provider, baristaId, 100)` → cwd/timeout 파라미터 순서 오류

### [10:12] 테스트 수정 - barista-engine-v2.test.ts
- MockSession 클래스를 EventEmitter 기반으로 재작성
- 이벤트 포워딩 로직 추가 (session:started → order:started)
- `getFailedState`, `canFollowup` 테스트 수정 (engine 구현에 맞춤)

### [10:14] 테스트 수정 - terminal-pool.test.ts
- `acquireLease(PROVIDER_ID, 'barista-overflow', 100)`
- → `acquireLease(PROVIDER_ID, 'barista-overflow', undefined, 100)`
- 파라미터 순서: (provider, baristaId, cwd?, timeoutMs?)

### [10:15] Task #1 완료
- **Result**: 56/56 tests passed
- **Time spent**: ~15 minutes

### [10:16] Task #2: Week 1 Quick Wins 리팩토링
- **Status**: in_progress

### [10:17] 1.1 상수 파일 추출 (role-instructions, signal-format)
- Created: `src/barista/prompts/role-instructions.ts`
  - `ROLE_DESCRIPTIONS`, `ROLE_INSTRUCTIONS` 상수
  - `getRoleDescription()`, `getRoleInstructions()` 헬퍼 함수
- Created: `src/barista/prompts/signal-format.ts`
  - `SIGNAL_FORMAT_TEMPLATE`, `CRITICAL_REMINDER` 상수
  - `SignalAction`, `SignalComplexity`, `StageSignals` 타입
- Created: `src/barista/prompts/index.ts`
- Updated: `barista-engine-v2.ts` → 추출된 상수 사용

### [10:18] 1.2 TerminalStatus enum 생성
- Created: `src/terminal/types.ts`
  - `TerminalStatus` enum (IDLE, BUSY, CRASHED, INITIALIZING)
  - `isTerminalStatus()`, `isAvailableStatus()`, `needsRestart()` 헬퍼
- Updated: `src/terminal/index.ts` → export 추가

### [10:19] 1.3 EventForwarder 유틸리티 생성
- Created: `src/utils/event-forwarder.ts`
  - `EventForwarder.relay()` - 다중 이벤트 포워딩
  - `EventForwarder.relayWithMap()` - 변환/필터 적용
  - `EventForwarder.relayOnce()` - 일회성 포워딩
- Created: `src/utils/index.ts`

### [10:20] 1.4 SKILL_NAMES 상수 정의
- Created: `src/constants/skills.ts`
  - `SKILL_NAMES` 상수 (10개 스킬)
  - `SkillName` 타입
  - `SKILL_FILE_MAP`, `getSkillFileName()`, `isKnownSkill()` 헬퍼
- Created: `src/constants/index.ts`

### [10:21] Task #2 완료 - 빌드/테스트 검증
- **Build**: OK
- **Tests**: 56/56 passed
- **Time spent**: ~5 minutes

## Decision log

| Time | Decision | Reason | Alternative |
|------|----------|--------|-------------|
| 10:05 | 실패 테스트 먼저 수정 | 리팩토링 회귀 검증 베이스라인 필요 | skip 처리 후 진행 (rejected) |
| 10:05 | API 스펙 유지, 내부만 리팩토링 | 하위 패키지 호환성 | Breaking change 허용 (rejected) |
| 10:12 | MockSession을 EventEmitter로 변경 | 실제 세션 이벤트 흐름 시뮬레이션 | 이벤트 대기 제거 (rejected) |
| 10:17 | prompts/ 디렉토리에 상수 추출 | 관심사 분리, 유지보수성 | 기존 파일에 유지 (rejected) |

## Issue log

### Issue #1: barista-engine-v2.test.ts 16개 테스트 timeout
- **Found at**: 10:10
- **Problem**: `order:started` 이벤트 대기 중 timeout (5000ms)
- **Cause**: mockSession이 EventEmitter가 아니어서 이벤트 전파 안됨
- **Fix**: MockSession 클래스를 EventEmitter 확장으로 재작성, 이벤트 포워딩 로직 추가
- **Time spent**: 5m
- **Prevention**: 테스트 mock 작성 시 실제 클래스 구조 확인

### Issue #2: terminal-pool.test.ts 1개 테스트 timeout
- **Found at**: 10:10
- **Problem**: `should enforce pool size limit` 테스트 timeout
- **Cause**: `acquireLease(provider, baristaId, 100)` - 100이 cwd로 전달됨 (timeout이 아님)
- **Fix**: `acquireLease(PROVIDER_ID, 'barista-overflow', undefined, 100)` 로 수정
- **Time spent**: 2m
- **Prevention**: 함수 시그니처 변경 시 호출부 모두 검토

### Issue #3: getRetryOptions/canFollowup 테스트 실패
- **Found at**: 10:14
- **Problem**: 테스트가 존재하지 않는 메서드 mock
- **Cause**: engine이 `session.getRetryOptions()`가 아닌 `session.getFailedState().retryOptions` 사용
- **Fix**: 테스트에서 올바른 메서드 mock (`getFailedState`, `getStatus`)
- **Time spent**: 3m
- **Prevention**: 구현 코드 확인 후 테스트 작성

## Files Changed

### Created (Week 1)
| File | Purpose |
|------|---------|
| `src/barista/prompts/role-instructions.ts` | Role descriptions/instructions 상수 |
| `src/barista/prompts/signal-format.ts` | Signal format template 상수 |
| `src/barista/prompts/index.ts` | Prompts 모듈 export |
| `src/terminal/types.ts` | TerminalStatus enum |
| `src/utils/event-forwarder.ts` | EventForwarder 유틸리티 |
| `src/utils/index.ts` | Utils 모듈 export |
| `src/constants/skills.ts` | SKILL_NAMES 상수 |
| `src/constants/index.ts` | Constants 모듈 export |

### Modified
| File | Change |
|------|--------|
| `src/__tests__/barista-engine-v2.test.ts` | MockSession 재작성, 테스트 수정 |
| `src/__tests__/terminal-pool.test.ts` | acquireLease 파라미터 수정 |
| `src/barista/barista-engine-v2.ts` | buildStagePrompt 리팩토링 |
| `src/terminal/index.ts` | types.ts export 추가 |

## Remaining Work

### Week 2: Core Services (pending)
- [ ] RetryPolicy 서비스 구현
- [ ] WorkflowLoader 서비스 추출
- [ ] ParallelStageProcessor 클래스 추출

### Week 3: State Management (pending)
- [ ] SessionStateMachine 구현
- [ ] OrderSession 리팩토링
- [ ] StageEvaluator Strategy 패턴 적용

### Week 4: Resource Management (pending)
- [ ] ResourceLifecycleManager 구현
- [ ] TerminalPool 리소스 관리 통합
- [ ] 전체 통합 테스트

## Retrospective notes

### What went well
- 테스트 실패 원인 분석이 빠르게 진행됨
- PM 스킬 체인이 작업 범위/우선순위 명확화에 도움
- 상수 추출로 buildStagePrompt 77줄 → 30줄 (60% 감소)

### What to improve
- 테스트 mock 작성 시 실제 구현 확인 필요
- 함수 시그니처 변경 시 호출부 전수 검토

### Lessons learned
- EventEmitter 기반 테스트는 이벤트 흐름 전체를 시뮬레이션해야 함
- 파라미터 순서 오류는 TypeScript로 잡기 어려움 (optional params)
