{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["workflow"],
  "properties": {
    "workflow": {
      "type": "object",
      "required": ["name", "stages", "loop"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Workflow name"
        },
        "description": {
          "type": "string",
          "description": "Workflow description"
        },
        "stages": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["analyze", "plan", "code", "review", "test", "check"]
          },
          "minItems": 1,
          "description": "List of stages to execute in order"
        },
        "loop": {
          "type": "object",
          "required": ["max_iters", "fallback_next_stage", "stop_when"],
          "properties": {
            "max_iters": {
              "type": "integer",
              "minimum": 1,
              "maximum": 20,
              "description": "Maximum number of iterations before stopping"
            },
            "fallback_next_stage": {
              "type": "string",
              "enum": ["analyze", "plan", "code", "review", "test", "check"],
              "description": "Default stage to return to if check fails (legacy, now defaults to first stage)"
            },
            "stop_when": {
              "type": "string",
              "description": "JSONPath condition for stopping (e.g., '$.done == true')"
            }
          }
        }
      }
    },
    "analyze": {
      "oneOf": [
        { "type": "string", "description": "Profile name for analyze stage (backward compatibility)" },
        {
          "type": "object",
          "description": "Analyze stage configuration",
          "properties": {
            "provider": { "type": "string", "enum": ["claude-code", "codex", "gemini", "grok"] },
            "role": { "type": "string" },
            "profile": { "type": "string" },
            "mode": { "type": "string", "enum": ["sequential", "parallel"], "description": "Execution mode (default: sequential)" },
            "on_failure": { "type": "string", "enum": ["stop", "continue", "retry"], "description": "Failure handling strategy" },
            "retries": { "type": "integer", "minimum": 0, "maximum": 10, "description": "Number of retries when on_failure is 'retry'" },
            "retry_backoff": { "type": "number", "minimum": 0, "description": "Backoff multiplier in seconds for retries" },
            "skills": { "type": "array", "items": { "type": "string" }, "description": "List of skill names to use" },
            "prompt": { "type": "string", "description": "Custom prompt template for this stage" }
          }
        }
      ]
    },
    "plan": {
      "oneOf": [
        { "type": "string", "description": "Profile name for plan stage (backward compatibility)" },
        {
          "type": "object",
          "description": "Plan stage configuration",
          "properties": {
            "provider": { "type": "string", "enum": ["claude-code", "codex", "gemini", "grok"] },
            "role": { "type": "string" },
            "profile": { "type": "string" },
            "mode": { "type": "string", "enum": ["sequential", "parallel"], "description": "Execution mode (default: sequential)" },
            "on_failure": { "type": "string", "enum": ["stop", "continue", "retry"], "description": "Failure handling strategy" },
            "retries": { "type": "integer", "minimum": 0, "maximum": 10, "description": "Number of retries when on_failure is 'retry'" },
            "retry_backoff": { "type": "number", "minimum": 0, "description": "Backoff multiplier in seconds for retries" },
            "skills": { "type": "array", "items": { "type": "string" }, "description": "List of skill names to use" },
            "prompt": { "type": "string", "description": "Custom prompt template for this stage" }
          }
        }
      ]
    },
    "code": {
      "oneOf": [
        { "type": "string", "description": "Profile name for code stage (backward compatibility)" },
        {
          "type": "object",
          "description": "Code stage configuration",
          "properties": {
            "provider": { "type": "string", "enum": ["claude-code", "codex", "gemini", "grok"] },
            "role": { "type": "string" },
            "profile": { "type": "string" },
            "mode": { "type": "string", "enum": ["sequential", "parallel"], "description": "Execution mode (default: sequential)" },
            "on_failure": { "type": "string", "enum": ["stop", "continue", "retry"], "description": "Failure handling strategy" },
            "retries": { "type": "integer", "minimum": 0, "maximum": 10, "description": "Number of retries when on_failure is 'retry'" },
            "retry_backoff": { "type": "number", "minimum": 0, "description": "Backoff multiplier in seconds for retries" },
            "skills": { "type": "array", "items": { "type": "string" }, "description": "List of skill names to use" },
            "prompt": { "type": "string", "description": "Custom prompt template for this stage" }
          }
        }
      ]
    },
    "review": {
      "oneOf": [
        { "type": "string", "description": "Profile name for review stage (backward compatibility)" },
        {
          "type": "object",
          "description": "Review stage configuration (can determine workflow completion)",
          "properties": {
            "provider": { "type": "string", "enum": ["claude-code", "codex", "gemini", "grok"] },
            "role": { "type": "string" },
            "profile": { "type": "string" },
            "mode": { "type": "string", "enum": ["sequential", "parallel"], "description": "Execution mode (default: sequential)" },
            "on_failure": { "type": "string", "enum": ["stop", "continue", "retry"], "description": "Failure handling strategy" },
            "retries": { "type": "integer", "minimum": 0, "maximum": 10, "description": "Number of retries when on_failure is 'retry'" },
            "retry_backoff": { "type": "number", "minimum": 0, "description": "Backoff multiplier in seconds for retries" },
            "min_iterations": { "type": "integer", "minimum": 0, "maximum": 100, "description": "Minimum times this stage must run before completion is allowed" },
            "skills": { "type": "array", "items": { "type": "string" }, "description": "List of skill names to use" },
            "prompt": { "type": "string", "description": "Custom prompt template for this stage" }
          }
        }
      ]
    },
    "test": {
      "oneOf": [
        { "type": "string", "description": "Profile name for test stage (backward compatibility)" },
        {
          "type": "object",
          "description": "Test stage configuration",
          "properties": {
            "provider": { "type": "string", "enum": ["claude-code", "codex", "gemini", "grok"] },
            "role": { "type": "string" },
            "profile": { "type": "string" },
            "mode": { "type": "string", "enum": ["sequential", "parallel"], "description": "Execution mode (default: sequential)" },
            "on_failure": { "type": "string", "enum": ["stop", "continue", "retry"], "description": "Failure handling strategy" },
            "retries": { "type": "integer", "minimum": 0, "maximum": 10, "description": "Number of retries when on_failure is 'retry'" },
            "retry_backoff": { "type": "number", "minimum": 0, "description": "Backoff multiplier in seconds for retries" },
            "skills": { "type": "array", "items": { "type": "string" }, "description": "List of skill names to use" },
            "prompt": { "type": "string", "description": "Custom prompt template for this stage" }
          }
        }
      ]
    },
    "check": {
      "oneOf": [
        { "type": "string", "description": "Profile name for check stage (backward compatibility)" },
        {
          "type": "object",
          "description": "Check stage configuration (can determine workflow completion)",
          "properties": {
            "provider": { "type": "string", "enum": ["claude-code", "codex", "gemini", "grok"] },
            "role": { "type": "string" },
            "profile": { "type": "string" },
            "mode": { "type": "string", "enum": ["sequential", "parallel"], "description": "Execution mode (default: sequential)" },
            "on_failure": { "type": "string", "enum": ["stop", "continue", "retry"], "description": "Failure handling strategy" },
            "retries": { "type": "integer", "minimum": 0, "maximum": 10, "description": "Number of retries when on_failure is 'retry'" },
            "retry_backoff": { "type": "number", "minimum": 0, "description": "Backoff multiplier in seconds for retries" },
            "min_iterations": { "type": "integer", "minimum": 0, "maximum": 100, "description": "Minimum times this stage must run before completion is allowed" },
            "skills": { "type": "array", "items": { "type": "string" }, "description": "List of skill names to use" },
            "prompt": { "type": "string", "description": "Custom prompt template for this stage" }
          }
        }
      ]
    }
  }
}
